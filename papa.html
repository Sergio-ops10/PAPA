<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Diario de Caja</title>
    <!-- Tailwind CSS para estilos rápidos y bonitos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilos para impresión */
        @media print {
            body { background-color: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            input { border: none; background: transparent; }
            tr[style*="background-color"] { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            td, th { border: 1px solid black !important; }
            
            /* Forzar colores en footer para impresión */
            tfoot tr:first-child { background-color: #e5e7eb !important; color: black !important; }
            tfoot tr:last-child { background-color: #9ca3af !important; color: black !important; }
        }

        /* Estilos generales */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        
        .cell-input:focus { outline: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 min-h-screen p-4 md:p-8">

    <div class="max-w-5xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden print:shadow-none print:max-w-full relative">
        
        <!-- HEADER -->
        <div class="bg-gray-800 text-white p-4 flex flex-col md:flex-row justify-between items-center no-print">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <i data-lucide="calendar" class="w-6 h-6 text-blue-400"></i>
                <h1 class="text-xl font-bold">Control Diario</h1>
            </div>

            <div class="flex items-center bg-gray-700 rounded-lg p-1">
                <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-600 rounded-md"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                <span id="currentMonthLabel" class="px-4 font-bold text-lg min-w-[160px] text-center uppercase"></span>
                <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-600 rounded-md"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
            </div>

            <div class="flex space-x-2 mt-4 md:mt-0">
                <button onclick="toggleSettings(true)" class="p-2 bg-gray-600 hover:bg-gray-500 rounded transition-colors" title="Ajustes">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
                <button onclick="window.print()" class="flex items-center space-x-1 px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm transition-colors">
                    <i data-lucide="printer" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Imprimir</span>
                </button>
                <button onclick="resetMonth()" class="flex items-center space-x-1 px-3 py-2 bg-red-600 hover:bg-red-500 rounded text-sm transition-colors">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Limpiar</span>
                </button>
            </div>
        </div>

        <!-- Header visible solo en impresión -->
        <div class="hidden print:block text-center p-4">
            <h1 id="printTitle" class="text-2xl font-bold uppercase"></h1>
        </div>

        <!-- TABLA -->
        <div class="overflow-x-auto">
            <table class="w-full border-collapse text-sm" id="mainTable">
                <thead>
                    <tr class="bg-white text-black border-b-2 border-black">
                        <th class="py-3 px-2 border-r border-black w-20 uppercase font-bold tracking-wider">Fecha</th>
                        <th class="py-3 px-2 border-r border-black w-1/5 uppercase font-bold tracking-wider">Turno</th>
                        <th class="py-3 px-2 border-r border-black w-1/5 uppercase font-bold tracking-wider">Tarjetas</th>
                        <th class="py-3 px-2 border-r border-black w-1/5 uppercase font-bold tracking-wider">Vales</th>
                        <th class="py-3 px-2 border-r border-black w-1/5 uppercase font-bold tracking-wider bg-gray-100">Efectivo</th>
                        <th class="py-3 px-2 border-r border-black w-1/5 uppercase font-bold tracking-wider">Joyería</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Las filas se generarán con JS -->
                </tbody>
                <tfoot>
                    <!-- Total Mes Actual -->
                    <tr class="bg-gray-800 text-white font-bold border-t-2 border-black">
                        <td id="footerLabelMonth" class="py-3 px-4 text-center border-r border-gray-600 text-xs uppercase">TOTAL MES</td>
                        <td id="totalMonthTurno" class="py-3 px-4 text-right border-r border-gray-600">0,00 €</td>
                        <td id="totalMonthTarjetas" class="py-3 px-4 text-right border-r border-gray-600">0,00 €</td>
                        <td id="totalMonthVales" class="py-3 px-4 text-right border-r border-gray-600">0,00 €</td>
                        <td id="totalMonthEfectivo" class="py-3 px-4 text-right border-r border-gray-600 bg-gray-700">0,00 €</td>
                        <td id="totalMonthJoyeria" class="py-3 px-4 text-right border-r border-gray-600">0,00 €</td>
                    </tr>
                    <!-- Total Global -->
                    <tr class="bg-black text-yellow-400 font-bold border-t-2 border-gray-600">
                        <td class="py-3 px-4 text-center border-r border-gray-800 text-xs uppercase tracking-widest">TOTAL GLOBAL</td>
                        <td id="totalGlobalTurno" class="py-3 px-4 text-right border-r border-gray-800">0,00 €</td>
                        <td id="totalGlobalTarjetas" class="py-3 px-4 text-right border-r border-gray-800">0,00 €</td>
                        <td id="totalGlobalVales" class="py-3 px-4 text-right border-r border-gray-800">0,00 €</td>
                        <td id="totalGlobalEfectivo" class="py-3 px-4 text-right border-r border-gray-800 bg-gray-900">0,00 €</td>
                        <td id="totalGlobalJoyeria" class="py-3 px-4 text-right border-r border-gray-800">0,00 €</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="p-4 text-xs text-gray-500 flex flex-col gap-1 no-print">
            <p>* Clic en el número del día para cambiar su color manualmente.</p>
            <p>* La fila "Total Global" suma todos los datos históricos guardados.</p>
        </div>

        <!-- MODAL DE AJUSTES -->
        <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center px-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5"></i> Personalización
                    </h2>
                    <button onclick="toggleSettings(false)" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- Días Automáticos -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <label class="block text-sm font-bold text-gray-700 mb-3">Días resaltados automáticamente:</label>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2" id="weekdaysContainer">
                            <!-- Se generan con JS -->
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Selecciona los días que siempre quieres pintar (ej. Domingos).</p>
                    </div>

                    <!-- Color -->
                    <div class="flex items-center justify-between p-2">
                        <span class="text-sm font-medium text-gray-700">Color de resaltado:</span>
                        <input type="color" id="colorPicker" class="h-9 w-16 cursor-pointer rounded border border-gray-300">
                    </div>

                    <hr>

                    <!-- Importar/Exportar -->
                    <div>
                        <h3 class="text-sm font-bold text-gray-700 mb-3">Gestión de Datos</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="exportToCSV()" class="flex flex-col items-center justify-center p-3 border-2 border-green-100 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition-colors">
                                <i data-lucide="download" class="w-5 h-5 mb-1"></i>
                                <span class="text-xs font-bold">Exportar Excel</span>
                            </button>
                            <button onclick="document.getElementById('fileInput').click()" class="flex flex-col items-center justify-center p-3 border-2 border-blue-100 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors">
                                <i data-lucide="upload" class="w-5 h-5 mb-1"></i>
                                <span class="text-xs font-bold">Importar Datos</span>
                            </button>
                            <input type="file" id="fileInput" accept=".csv" class="hidden" onchange="handleFileImport(this)">
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="toggleSettings(false)" class="px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-700 transition-colors">Guardar y Cerrar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- ESTADO DE LA APLICACIÓN ---
        let currentDate = new Date();
        let appData = {};
        let weekendColor = '#c53030';
        let defaultHighlightedDays = [0, 6]; // 0 Dom, 6 Sab
        let manualHighlights = {};

        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const weekdays = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];

        // --- INICIALIZACIÓN ---
        window.onload = function() {
            loadFromStorage();
            renderApp();
            lucide.createIcons();
            
            // Listener para el color picker
            document.getElementById('colorPicker').value = weekendColor;
            document.getElementById('colorPicker').addEventListener('input', (e) => {
                weekendColor = e.target.value;
                saveToStorage();
                renderTable();
            });
        };

        // --- LÓGICA DE DATOS Y CÁLCULOS ---
        
        function loadFromStorage() {
            const savedData = localStorage.getItem('cajaData');
            if (savedData) appData = JSON.parse(savedData);
            
            const savedHighlights = localStorage.getItem('manualHighlights');
            if (savedHighlights) manualHighlights = JSON.parse(savedHighlights);

            const savedDefaults = localStorage.getItem('defaultHighlightedDays');
            if (savedDefaults) defaultHighlightedDays = JSON.parse(savedDefaults);

            const savedColor = localStorage.getItem('weekendColor');
            if (savedColor) weekendColor = savedColor;
        }

        function saveToStorage() {
            localStorage.setItem('cajaData', JSON.stringify(appData));
            localStorage.setItem('manualHighlights', JSON.stringify(manualHighlights));
            localStorage.setItem('defaultHighlightedDays', JSON.stringify(defaultHighlightedDays));
            localStorage.setItem('weekendColor', weekendColor);
        }

        function getKey(day) {
            return `${currentDate.getFullYear()}-${currentDate.getMonth()}-${day}`;
        }

        function getValue(day, field) {
            const key = getKey(day);
            return appData[key]?.[field] || '';
        }

        function updateValue(day, field, value) {
            const key = getKey(day);
            if (!appData[key]) appData[key] = {};
            appData[key][field] = parseFloat(value) || 0;
            saveToStorage();
            renderRowCalculations(day); // Solo actualizamos los cálculos de esa fila
            renderTotals(); // Actualizamos totales
        }

        function calculateEfectivo(day) {
            const turno = getValue(day, 'turno') || 0;
            const tarjetas = getValue(day, 'tarjetas') || 0;
            const vales = getValue(day, 'vales') || 0;
            return turno - tarjetas - vales;
        }

        // --- RENDERIZADO ---

        function renderApp() {
            renderHeader();
            renderTable();
            renderSettingsWeekdays();
        }

        function renderHeader() {
            const label = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear().toString().slice(-2)}`;
            document.getElementById('currentMonthLabel').textContent = label;
            document.getElementById('printTitle').textContent = `${monthNames[currentDate.getMonth()]} - ${currentDate.getFullYear()}`;
            document.getElementById('footerLabelMonth').textContent = `TOTAL ${monthNames[currentDate.getMonth()]}`;
        }

        function renderTable() {
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            for (let i = 1; i <= daysInMonth; i++) {
                const row = document.createElement('tr');
                row.className = "border-b border-gray-300 transition-colors";
                row.id = `row-${i}`;

                // Comprobar resaltado
                const highlighted = isDayHighlighted(i);
                applyRowStyles(row, highlighted);

                // Nombre del día
                const dateObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                const dayName = dateObj.toLocaleDateString('es-ES', { weekday: 'short' });

                // HTML de la fila
                row.innerHTML = `
                    <td class="px-2 py-1 border-r border-gray-400 text-center cursor-pointer select-none relative group" 
                        onclick="toggleDayHighlight(${i})" title="Clic para cambiar color">
                        <div class="flex flex-col items-center leading-tight">
                            <span class="font-bold text-lg">${i}</span>
                            <span class="text-[10px] uppercase opacity-80">${dayName}</span>
                        </div>
                    </td>
                    <td class="p-0 border-r border-gray-400"><input type="number" step="0.01" class="cell-input w-full text-right p-2" placeholder="0.00" value="${getValue(i, 'turno') || ''}" oninput="updateValue(${i}, 'turno', this.value)"></td>
                    <td class="p-0 border-r border-gray-400"><input type="number" step="0.01" class="cell-input w-full text-right p-2" placeholder="0.00" value="${getValue(i, 'tarjetas') || ''}" oninput="updateValue(${i}, 'tarjetas', this.value)"></td>
                    <td class="p-0 border-r border-gray-400"><input type="number" step="0.01" class="cell-input w-full text-right p-2" placeholder="0.00" value="${getValue(i, 'vales') || ''}" oninput="updateValue(${i}, 'vales', this.value)"></td>
                    <td class="px-4 py-1 text-right border-r border-gray-400 font-mono font-medium" id="efectivo-${i}">
                        ${formatCurrency(calculateEfectivo(i))}
                    </td>
                    <td class="p-0 border-r border-gray-400"><input type="number" step="0.01" class="cell-input w-full text-right p-2" placeholder="0.00" value="${getValue(i, 'joyeria') || ''}" oninput="updateValue(${i}, 'joyeria', this.value)"></td>
                `;

                // Ajustar estilos de inputs según color de fila
                updateInputStyles(row, highlighted);

                tbody.appendChild(row);
            }
            renderTotals();
        }

        function renderRowCalculations(day) {
            const efVal = calculateEfectivo(day);
            document.getElementById(`efectivo-${day}`).textContent = efVal !== 0 ? formatCurrency(efVal) : '-';
        }

        function renderTotals() {
            // Totales Mes
            let mTotals = { turno: 0, tarjetas: 0, vales: 0, efectivo: 0, joyeria: 0 };
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();

            for (let i = 1; i <= daysInMonth; i++) {
                mTotals.turno += (getValue(i, 'turno') || 0);
                mTotals.tarjetas += (getValue(i, 'tarjetas') || 0);
                mTotals.vales += (getValue(i, 'vales') || 0);
                mTotals.efectivo += calculateEfectivo(i);
                mTotals.joyeria += (getValue(i, 'joyeria') || 0);
            }

            // Totales Globales
            let gTotals = { turno: 0, tarjetas: 0, vales: 0, efectivo: 0, joyeria: 0 };
            Object.keys(appData).forEach(key => {
                const d = appData[key];
                gTotals.turno += (d.turno || 0);
                gTotals.tarjetas += (d.tarjetas || 0);
                gTotals.vales += (d.vales || 0);
                gTotals.efectivo += (d.turno || 0) - (d.tarjetas || 0) - (d.vales || 0);
                gTotals.joyeria += (d.joyeria || 0);
            });

            // Pintar Mes
            document.getElementById('totalMonthTurno').textContent = formatCurrency(mTotals.turno);
            document.getElementById('totalMonthTarjetas').textContent = formatCurrency(mTotals.tarjetas);
            document.getElementById('totalMonthVales').textContent = formatCurrency(mTotals.vales);
            document.getElementById('totalMonthEfectivo').textContent = formatCurrency(mTotals.efectivo);
            document.getElementById('totalMonthJoyeria').textContent = formatCurrency(mTotals.joyeria);

            // Pintar Global
            document.getElementById('totalGlobalTurno').textContent = formatCurrency(gTotals.turno);
            document.getElementById('totalGlobalTarjetas').textContent = formatCurrency(gTotals.tarjetas);
            document.getElementById('totalGlobalVales').textContent = formatCurrency(gTotals.vales);
            document.getElementById('totalGlobalEfectivo').textContent = formatCurrency(gTotals.efectivo);
            document.getElementById('totalGlobalJoyeria').textContent = formatCurrency(gTotals.joyeria);
        }

        function renderSettingsWeekdays() {
            const container = document.getElementById('weekdaysContainer');
            container.innerHTML = '';
            weekdays.forEach((day, index) => {
                const isSelected = defaultHighlightedDays.includes(index);
                const btn = document.createElement('button');
                btn.className = `text-xs py-2 px-3 rounded border transition-colors flex items-center justify-between ${isSelected ? 'bg-blue-100 border-blue-300 text-blue-800' : 'bg-white border-gray-300 text-gray-600 hover:bg-gray-50'}`;
                btn.innerHTML = `${day} ${isSelected ? '<i data-lucide="check-square" class="w-3 h-3 ml-1"></i>' : '<i data-lucide="square" class="w-3 h-3 ml-1 opacity-30"></i>'}`;
                btn.onclick = () => toggleDefaultWeekday(index);
                container.appendChild(btn);
            });
            lucide.createIcons();
        }

        // --- ESTILOS Y AYUDAS VISUALES ---

        function isDayHighlighted(day) {
            const key = getKey(day);
            if (manualHighlights.hasOwnProperty(key)) return manualHighlights[key];
            const dateObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            return defaultHighlightedDays.includes(dateObj.getDay());
        }

        function toggleDayHighlight(day) {
            const key = getKey(day);
            const current = isDayHighlighted(day);
            manualHighlights[key] = !current;
            saveToStorage();
            renderTable(); // Re-render para aplicar cambios
        }

        function toggleDefaultWeekday(index) {
            if (defaultHighlightedDays.includes(index)) {
                defaultHighlightedDays = defaultHighlightedDays.filter(d => d !== index);
            } else {
                defaultHighlightedDays.push(index);
            }
            saveToStorage();
            renderTable();
            renderSettingsWeekdays();
        }

        function applyRowStyles(row, isHighlighted) {
            if (isHighlighted) {
                row.style.backgroundColor = weekendColor;
                row.style.color = 'white';
            } else {
                row.style.backgroundColor = 'white';
                row.style.color = '#1f2937'; // gray-800
            }
        }

        function updateInputStyles(row, isHighlighted) {
            const inputs = row.querySelectorAll('input');
            inputs.forEach(input => {
                if (isHighlighted) {
                    input.classList.remove('focus:bg-blue-50');
                    input.classList.add('bg-transparent', 'text-white', 'focus:bg-black/10', 'placeholder-white/50');
                } else {
                    input.classList.remove('text-white', 'focus:bg-black/10', 'placeholder-white/50');
                    input.classList.add('bg-transparent', 'text-gray-800', 'focus:bg-blue-50');
                }
            });
        }

        function formatCurrency(val) {
            return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(val || 0);
        }

        // --- NAVEGACIÓN Y ACCIONES ---

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderApp();
        }

        function resetMonth() {
            if (confirm('¿Borrar datos de este mes?')) {
                const prefix = `${currentDate.getFullYear()}-${currentDate.getMonth()}`;
                Object.keys(appData).forEach(k => {
                    if (k.startsWith(prefix)) delete appData[k];
                });
                saveToStorage();
                renderTable();
            }
        }

        function toggleSettings(show) {
            const modal = document.getElementById('settingsModal');
            if (show) modal.classList.remove('hidden');
            else modal.classList.add('hidden');
        }

        // --- EXPORTAR / IMPORTAR ---

        function exportToCSV() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let csv = "data:text/csv;charset=utf-8,Fecha,Dia,Turno,Tarjetas,Vales,Efectivo,Joyeria\n";
            
            // Totales actuales para el csv
            let tT=0, tTa=0, tV=0, tE=0, tJ=0;

            for (let i = 1; i <= daysInMonth; i++) {
                const dayName = new Date(year, month, i).toLocaleDateString('es-ES', { weekday: 'short' });
                const t = getValue(i, 'turno') || 0;
                const ta = getValue(i, 'tarjetas') || 0;
                const v = getValue(i, 'vales') || 0;
                const e = t - ta - v;
                const j = getValue(i, 'joyeria') || 0;
                
                tT+=t; tTa+=ta; tV+=v; tE+=e; tJ+=j;

                csv += `${i}/${month + 1}/${year},${dayName},${t.toFixed(2)},${ta.toFixed(2)},${v.toFixed(2)},${e.toFixed(2)},${j.toFixed(2)}\n`;
            }
            
            csv += `TOTAL,MES ACTUAL,${tT.toFixed(2)},${tTa.toFixed(2)},${tV.toFixed(2)},${tE.toFixed(2)},${tJ.toFixed(2)}\n`;

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csv));
            link.setAttribute("download", `caja_${monthNames[month]}_${year}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                let count = 0;
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line || line.startsWith('TOTAL')) continue;
                    
                    const parts = line.split(',');
                    if(parts.length < 6) continue;
                    
                    const [dateStr, , turno, tarjetas, vales, , joyeria] = parts;
                    const [d, m, y] = dateStr.split('/');
                    
                    if(d && m && y) {
                        const key = `${y}-${parseInt(m)-1}-${parseInt(d)}`;
                        if(!appData[key]) appData[key] = {};
                        appData[key] = {
                            turno: parseFloat(turno) || 0,
                            tarjetas: parseFloat(tarjetas) || 0,
                            vales: parseFloat(vales) || 0,
                            joyeria: parseFloat(joyeria) || 0
                        };
                        count++;
                    }
                }
                saveToStorage();
                renderTable();
                alert(`Importado: ${count} registros.`);
                input.value = ''; // Reset
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>